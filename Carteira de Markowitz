# Instalando pacotes necessários

#install.packages("BatchGetSymbols")
#install.packages("tidyverse")
#install.packages("boot")
#install.packages(ggplot2)
#install.packages("fPortfolio")

library(BatchGetSymbols)
library(tidyverse)
library(boot)
library(ggplot2)
library(fPortfolio)

# Definindo as datas e a frequência da pesquisa

first.date <- as.Date("2018-01-01")
last.date <- Sys.Date()
freq.data <- "monthly"

# Definindo os ativos procurados

tickers <- c("ABEV3.SA", "AZUL4.SA", "GGBR3.SA", "GOLL11.SA", "ITUB4.SA",
           "MGLU3.SA", "PETR3.SA", "PSSA3.SA", "VALE3.SA", "WEGE3.SA")

# Extraindo os dados dos ativos

l.out <- BatchGetSymbols(tickers = tickers,
                         first.date = first.date,
                         last.date = last.date,
                         freq.data = freq.data,
                         cache.folder = file.path(tempdir(),
                                                  "BGS_Cache"))
# Visualizando os dados

print(l.out$df.control)

# Visualizando o histórico dos ativos

p <- ggplot(l.out$df.tickers,
            aes(x = ref.date,
                y = price.close)) +
     geom_line() +
     facet_wrap(~ ticker,
               scales = "free_y")

print(p)

# Extraindo os retornos

ambev <- l.out$df.tickers %>% 
         na.omit() %>% 
         filter(ticker == "ABEV3.SA") %>% 
         select(ret.closing.prices) %>% 
         rename(ambev = ret.closing.prices)

azul <- l.out$df.tickers %>% 
        na.omit() %>% 
        filter(ticker == "AZUL4.SA") %>% 
        select(ret.closing.prices) %>% 
        rename(azul = ret.closing.prices)

gerdal <- l.out$df.tickers %>% 
          na.omit() %>% 
          filter(ticker == "GGBR3.SA") %>% 
          select(ret.closing.prices) %>% 
          rename(gerdal = ret.closing.prices)

#gol <- l.out$df.tickers %>% 
#       na.omit() %>% 
#       filter(ticker == "GOLL11.SA") %>% 
#       select(ret.closing.prices) %>% 
#       rename(gol = ret.closing.prices)

#itau <- l.out$df.tickers %>% 
#        na.omit() %>% 
#        filter(ticker == "ITU4.SA") %>% 
#        select(ret.closing.prices) %>% 
#        rename(itau = ret.closing.prices)

magalu <- l.out$df.tickers %>% 
          na.omit() %>% 
          filter(ticker == "MGLU3.SA") %>% 
          select(ret.closing.prices) %>% 
          rename(magalu = ret.closing.prices)

petrobras <- l.out$df.tickers %>% 
             na.omit() %>% 
             filter(ticker == "PETR3.SA") %>% 
             select(ret.closing.prices) %>% 
             rename(petrobras = ret.closing.prices)

porto <- l.out$df.tickers %>% 
         na.omit() %>% 
         filter(ticker == "PSSA3.SA") %>% 
         select(ret.closing.prices) %>% 
         rename(porto = ret.closing.prices)

vale <- l.out$df.tickers %>% 
        na.omit() %>% 
        filter(ticker == "VALE3.SA") %>% 
        select(ret.closing.prices) %>% 
        rename(vale = ret.closing.prices)

weg <- l.out$df.tickers %>% 
       na.omit() %>% 
       filter(ticker == "WEGE3.SA") %>% 
       select(ret.closing.prices) %>% 
       rename(weg = ret.closing.prices)

retornos <- cbind(ambev, azul, gerdal, magalu, petrobras, porto, vale,
                  weg)

# Modelando os retornos enquanto séries temporais

retornos <- as.timeSeries(retornos)

# Definindo o portfólio eficiente

portfolio.eficiente <- tangencyPortfolio(retornos, spec = portfolioSpec(),
                                         constraints = "LongOnly")
portfolio.eficiente

# Definindo o portfólio de menor risco

portfolio.menor.risco <- minvariancePortfolio(retornos,
                                              spec = portfolioSpec(),
                                              constraints = "LongOnly")
portfolio.menor.risco

# Definindo e visualizando a fronteira de eficiência

fronteira <- portfolioFrontier(retornos)

frontierPlot(fronteira, col = c("blue", "red"), pch = 20)

monteCarloPoints(fronteira, mcSteps = 5000, pch = 20, cex = 0.25)

# Extraindo os pesos dos ativos da carteira

getWeights(portfolio.eficiente)
getWeights(portfolio.menor.risco)
